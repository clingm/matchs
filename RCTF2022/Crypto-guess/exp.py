from Crypto.Util.number import *
from sage.all import *
import time

d = 90
p = 966084508537262632106170383318041332186674538169
T = [303181258434531510588742447760243726673684456972, 765360542482117269649024194694128308977103956619, 446935476704751440050502040452024741762709523673, 828102511289921420115951256738083687366703132335, 887267648964524204042397215743134614953645934275, 460393972651417805510268252182009690527810017785, 558924295152526237448505346034923628908991801542, 887746853899540926754804043250352372036332713499, 806429756497703910820053267989278162455626044840, 893262839232758944732456947270118941642983674381, 347835454715594698482160056977269582543652631482, 511342184621680188772087763824654760543184343488, 6122564640523763016748069734437254921270060113, 860039518631576312245610071846863541592894888216, 882439633404706368500891072200546501566673219372, 301037230593480398703696978696323054954167729228, 449973179487074497457318232035825433219253104693, 341196214899488836342948886203371444823248930972, 57303810100440527831166667897480660155486563416, 925995709163351507825668937011099198781959724045, 649983314435761478069065885656534906755989470651, 72217807691536713795380029060407365497321785013, 164002154362132443024262320746212146738875946165, 545805291775622375644020051590651894567003680692, 725178770977745447942366505713146441381037470335, 683516579521378377762589614870162061331542474677, 713823115460328256053046628479210223497485883098, 651533670125247519006727523661949752132733515955, 747076937270444397620434072920260573867547972480, 140853000146293297896263216583930524236622663883, 895246599187537005453074672416881705156931164964, 947848785907859983998923510509682640844268872236, 222817243829599929147476145830091442216306224143, 516593953520664419305083483463785908155479905737, 418287474886243415852047383265772025529412990645, 38376150090781129479298439393063902381160548059, 293948041771845013865655972586561184173778958109, 6606870336153193246176484312886341312383262108, 471847799569697989994237074292530955148852237331, 775404151226663394169185695795353267735416323663, 436447225499499025016897065097245728569779524425, 599495208446510171831353119643715088938927821057, 641037820682275846192122250560573673947695701658, 773488555304575135167712502144010228749027067597, 702582425188719321603802947297565881910823800235, 431135503078575349570608640165262636280804260728, 320628530994549770247660925230063282120945615281, 960680324003544146058607909056668271015668358184, 413095208030362639977442550574035780441375799597, 625215944674674731043807575860485280441801624999, 376497686186979672549837582635748307962768655048, 395650640734017920381376837591301269477909835679, 404490513889645908800776336371492219793880540535, 284582508240331862845672413000739399250187304712, 211625765784985560377494724124044073448504416360, 36144930262843646794232377461221422515252091268, 115289619293730059104811187647968350986385589730, 603512435507450605887260972932341835388386100358, 893250719136134892362636962682044669064066844976, 604720930164867195672824164024688198055407348841, 556657527689268492803407193670230045433364394799, 778105233876108313038640246987513588062521797253, 469292817502649884885013035639655193972448104974, 78216186400837185423004910437522821237671914909, 585775790218431172703057142454774123894993938111, 352136472444457651658695048640062831137953014, 557540425816166825736591495689419886003396999890, 307999350907258605704042086167250451184806417841, 367068222926725253996448542051550585218918648184, 53497487453981965169244914387081949405220786159, 359758061522954910816632835955704054173600982538, 654729397917723628084906613154801672247574699639, 943265609339995749430427261269452049234914510159, 221951022176073474819654329276894577945516257063, 922604229133914795983258128196444675653272023126, 110400240071214316148531422429724063914334596956, 384915901421277330236674535418950179359743990785, 739578094385106652443303401969008324928804918285, 618253526731774222214740045640098692366178063742, 170319112696150545911052909970328311886031824850, 241409634767139514879429601531452986518373963094, 839529220905229167756428235395573794306094238498, 12277275184757009220231638730409545204210617763, 572755145903986703197373720641937448534076826996, 885222955495910596459612280317433211706727532852, 5479032841566246953887034517692300566473807117, 719360540968664884704122764024860112973471734288, 730271443787511667325859301819615190337368928607, 641682001793289705693867155252134275290032518884, 789846087417167892991834127400859340190076025599]
U = [86923087871390366562646931195608113535077600494012620819230590389290127260888195301465231777355, 219431445172373424542492087304369855663740115542800970510533946070501637574260460946661979106640, 128137906396472876903068778787871051433467318451036037989295266763968281563659715667994589315894, 237419778937016276590317785727011077407536342152349992856501380123680761921608687870937717916073, 254382623169430920623127963525016731965059789221122584977812176171255006353627768483238037785131, 131996502510986492262462471994290345099827245666310742702630810602888945152963328439555264034529, 160245477810393719334995305417920052153662075393849931221417781309640500464121895682303048054346, 254520012838205111006811014695182298971505560208184214350060272343916272051031177196853705370849, 231206127146841991715470567314255715698716717606560562525055091583147577634997919779614892940510, 256101464410417466255728623774112508933078866184261020805379720729718814600499011994634992896042, 99725596335162474327912776849780764385088486411107479616962267047899859192624351518490226307400, 146603526470343925469324211610481953701236682849048586675143357834726481936872663985613370982146, 1755359902503456973649547264650909959078020446794460187444716844914773248887442291065291953244, 246576226501888978764176446711280979527404693398467720148059957884103442218016407415755109359216, 252998414848252295727407653796497390118398037177889291022871628843560924011002967294517802702144, 86308387868531724636424960625417747908657581454303294396025452564313790937884334843536240945103, 129008826014784481457230326468501397774700470043943414786734976050150178329941242965055083418487, 97822103919719445727794648174939250799684989980144433965729698851307509918080111237105014604671, 16429195348173717768049292756532427741697868787419983804696507149719417494215789643541292774983, 265486088459908592736369888890184540724283878165937595916801558950728972836941854529521448835275, 186352405314781223422296504430426619155344814287609006615949534684104266932515091119350616625740, 20705088686100785919832760123687832170253121380006598966104308867678857107674656435259848300117, 47019969995260415033059327597316143181789821908609099699298036438599571818790880326803001492054, 156484215359001376748040671747472119562285968411364734818420085034366039837399274448292159057890, 207911195954670363082274491098827805896915038923069643914871652544761441396211040009983413343671, 195966505350852961616954371605773536347897406443579461247734585746809378284748098866422011705819, 204655491273337498052200808886142392578827769822182667780714912471099750257428766326141769171686, 186796897512369371394856084123772908340103521781010388140737964760373785048460137319015063364934, 214189473981191645561284537266038802051621700622509328024995514496272290683339931629324200823636, 40383029517997163501695741201438551337313970571772301794947127505479336384436915894700992180864, 256670215070518555579640000562485111888361290293320262648249266634698818645886735419334140735972, 271751439161107462018071824068476170146378467553142048656697799437017792757954048742473773662457, 63882454227768882263576656819605964258009262327849551432869671529656251499811364964762507149206, 148109226301012110394931851008079672592174270148120835261183136061309521127870205112371162871763, 119924427792063534626524907251016263402377171799571025654855411577730763602652289563841987349528, 11002571477309687481276489613323398245195168828800271610844040130385885850526932920690784067269, 84275893557828956652727572171743854706778285203963029973839812126201939889627704086051295792839, 1894211976524062164763931740652694512652334410168343830723888122691335015578276338164870362048, 135280353263576311568082352099122764782255308582814618238134515326962298204977713999902781064458, 222310981625107577845922091539385089783002188041524190531820810702473262840640021688832118483711, 125130889452751613049908586768244090223297801118136112457764072744571346131011202003614696632102, 171877295289761569612159680310488708478226551892046684592177738824477176596356813579042510545927, 183787702128304040640794995565439585232383868210905495465716082028352724588733425389254322161126, 221761773822746962614187992872149501770784725685028334094604696271403293797456168804180769116638, 201432747515167055531558088307954520382208572026983939750751585693737486052785359424807582500129, 123608000745427099348692444019947872705842916924026610363474176688485117405172905101104369320919, 91925279674674444158821520306448459951687370764316823212861943896783921692154796169107407913379, 275430284348225437732838262042734526304859333582720096392861621878921974686548672448083486964747, 118435787397548873359234660538224355386773537720618564910015607265229621068168775724198401357441, 179251516990739107958940478680406641571498519280320621926169773098419291386788947350219143450836, 107943154628975406791467244071021006181668748768236679815125139189450987958819973379409623681092, 113434371202471004132905948431076420501595838381456361955682644700490017142896621293545695144413, 115968792607824861872778427824732686047389734344765465954776954617596719656748033971761631762550, 81590763552347559226026526959496121497093844392805598586197574741040994536435134781592277397402, 60673819780818675201116482094399040453815002744412576196141807329654715663861727891917673228611, 10362873238158541602846319931829345203056489246038400731346732760567140006282128688161335003397, 33053922133158605021389602028690117047304204834016643857534370630264473939909458406726361266146, 173029047817673370303612030262636341703491533486905019755382352456593124675560655377332122076575, 256097989537896314884726966502586567893875437465867131829082499659995141757117010735636430664725, 173375527306020145935203756821467350767245281155002019512673057438980497106104855070664190837345, 159595587944476070999435634312645150503869174683175617161596089505629644600624044766490551952520, 223085391117626680916649391274281841599202280174552850309049634679768551011098514236718567384682, 134547831300079659152243932244336292936906693797673104181820151186768385748204171958404614254070, 22424844063879164702596540816638640298907111380882098259370216914315278504820082798659568870155, 167943891878411921353872094703819972639652895069174591772629019631388795228651195372048978358062, 100958712603340682199337929033129490460932218774380664898079677877770516598448531032544427523, 159848717810953097270255343325078462164374975138861886136215579806892456476748991659319254402450, 88304451210080305911318711146800768611786027183041180686670944812853370249637370163465711784528, 105239695754956209191361446551591439835154160370896963333410977309538132375999596844478265853689, 15337909826194708023452072160814247075739681768181616256722455624301084024032747658000781790785, 103143847860746125987381905251925720446899832910772229988594170940003646633920653143042232290358, 187713123433301186229799419473916624072970338170005099700798754007316294366086920813872250036926, 270437427003510370421777572116813659775398209190613048778718407384961124873425805105160117225104, 63634105562371940973089398488664574887081704085256725040973315568630198312704226161728958134896, 264513739713370055974773308510587156241399807177270082831763589719426684404697469847299441273812, 31652120643219014765249408377284581529132378950608374674845308320513979091173582764068504295681, 110356685288190420730838451786603962914431032470540248639225741313447109196918480618567928110024, 212039530470759529411818651501651770825784568306457932195373571803411184852836870909438934806645, 177255368317918783469887132833429977339904858134297668562830564570361725928365386162393165794288, 48831063224383404483735053870702607671997616740261512645209672755043782278985621309341630432347, 69212955326510034120101571974204568087891034300909620657027016061212949070574275024864505097552, 240695855067516065764044910147969266439847559702192635497700419797988759985281764486378684388377, 3519936143863980999039087256919119529676219909611122500750904298877920894930947383255172067494, 164210829301488242645196678031381233618602991229422912270184626026468007108657489922563611534812, 253796402665696394620864726472947704325182368855795920729203442439819036439770390823204126727511, 1570857168404221075405524841171967470049039392105829517215339833442860333536757098041826005107, 206243089815964303987912303072063154160121758449510550726002527963604926912155503907596234022448, 209371282400743147682357145813820433132326701090806293921537455421973259064856702732091912621241, 183972391022356635534419359772516938489937495716306846290224377435945960118056106757178662239451, 226451533369638682706462598355644462729918168281816654567454801209484516615151777317575814487624]
n = 160
k = ceil(sqrt(n)) + ceil(log(n, 2))
print(k)
answers = U
inputs = [t % p for t in T]


def build_basis(oracle_inputs):
    """Returns a basis using the HNP game parameters and inputs to our oracle
    """
    basis_vectors = []
    for i in range(d):
        p_vector = [0] * (d+1)
        p_vector[i] = p
        basis_vectors.append(p_vector)
    basis_vectors.append(list(oracle_inputs) + [QQ(1)/QQ(p)])
    return Matrix(QQ, basis_vectors)

def approximate_closest_vector(basis, v):
    """Returns an approximate CVP solution using Babai's nearest plane algorithm.
    """
    BL = basis.LLL()
    G, _ = BL.gram_schmidt()
    _, n = BL.dimensions()
    small = vector(ZZ, v)
    for i in reversed(range(n)):
        c = QQ(small * G[i]) / QQ(G[i] * G[i])
        c = c.round()
        small -= BL[i] * c
    return (v - small).coefficients()

startime = time.time()

# Build a basis using our oracle inputs
lattice = build_basis(inputs)
# print("Solving CVP using lattice with basis:\n%s\n" % str(lattice))

# The non-lattice vector based on the oracle's answers
u = vector(ZZ, list(answers) + [0])
# print("Vector of MSB oracle answers:\n%s\n" % str(u))

# Solve an approximate CVP to find a vector v which is likely to reveal alpha.
v = approximate_closest_vector(lattice, u)
# print("Closest lattice vector:\n%s\n" % str(v))

# Confirm the recovered value of alpha matches the expected value of alpha.
recovered_alpha = (v[-1] * p) % p

print("Recovered alpha! Alpha is %d" % recovered_alpha)
endtime = time.time()
print(f"Time Spending {endtime - startime}")
print(long_to_bytes(recovered_alpha))

